<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>Solving Minesweeper using Constraint Programming in Ruby</title>
  <link rel="stylesheet" type="text/css" href="../styles.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../css/webgen.css" media="screen" />
  <meta name="description" content="An example showing how to solve minesweeper using constraint programming in Ruby with Gecode/R." />
  
</head>
<body>
<div id="header">
  <a class="logoLink" href="../index.html" title="Gecode/R - constraint programming in Ruby">
  <span>Gecode/R - constraint programming in Ruby</span>
  </a>
  <a name="top"></a>
</div>
<div id="contents">
  <div id="breadcrumbs"><a href="../index.html">Home</a> > <a href="index.html">Examples</a> > <span>Minesweeper</span></div>
  <div id="sidebarWrapper">
    <div id="sidebar">
      <h3>Examples</h3><ul id="secondNav"><li><a href="index.html">Overview</a></li><li><a href="send-more-money.html">send+more=money</a></li><li><a href="send-most-money.html">send+most=money</a></li><li><a href="sudoku.html">Sudoku</a></li><li><a href="sudoku-set.html">Sudoku with sets</a></li><li><a href="n-queens.html">N-queens</a></li><li><a href="magic-sequence.html">Magic Sequence</a></li><li><a href="nonogram.html">Nonogram (Paint by Numbers)</a></li><li><a href="square-tiling.html">Square tiling</a></li><li><span>Minesweeper</span></li><li><a href="survo.html">Survo Puzzle</a></li></ul>
      <h3>Shortcuts</h3>
      <ul class="section-links"><li><a href="#problem">Problem</a></li><li><a href="#code">Code</a></li><li><a href="#output">Output</a></li></ul>

      <form id="searchbox_000699377096513254569:zhhnzsrbzfu" action="http://www.google.com/cse" 
        onsubmit="pageTracker._trackPageview('/search/' + document.getElementById('q').value);">
        <fieldset>
          <legend>Search the site</legend>
          <input type="hidden" name="cx" value="000699377096513254569:zhhnzsrbzfu" />
          <input type="hidden" name="cof" value="FORID:0" />
          <input id="q" name="q" type="text" size="15" />
          <input type="submit" name="sa" value="Search" />
        </fieldset>
      </form>
    </div>
  </div>
  <div id="body">
    <h1>Minesweeper</h1>


	<h2 id="problem">Problem</h2>


	<p>Minesweeper is a logic puzzle where the goal is to deduce the location
of mines in a minefield. The player is given a specification where each
square is either unknown, or is known to not contain a mine and have a
specified number of mines adjacent to it.</p>


	<h2 id="code">Code</h2>


	<p><div class="CodeRay">
  <div class="code"><pre><span class="no">  1</span> require <span class="s"><span class="dl">'</span><span class="k">rubygems</span><span class="dl">'</span></span>
<span class="no">  2</span> require <span class="s"><span class="dl">'</span><span class="k">gecoder</span><span class="dl">'</span></span>
<span class="no">  3</span> require <span class="s"><span class="dl">'</span><span class="k">enumerator</span><span class="dl">'</span></span>
<span class="no">  4</span> 
<span class="no">  5</span> <span class="c">#</span>
<span class="no">  6</span> <span class="c"># Minesweeper in Gecode/R</span>
<span class="no">  7</span> <span class="c">#</span>
<span class="no">  8</span> <span class="c"># From gecode/examples/minesweeper.cc:</span>
<span class="no">  9</span> <span class="c"># &quot;&quot;&quot;</span>
<span class="no"> <strong>10</strong></span> <span class="c"># A specification is a square matrix of characters. Alphanumeric </span>
<span class="no"> 11</span> <span class="c"># characters represent the number of mines adjacent to that field. </span>
<span class="no"> 12</span> <span class="c"># Dots represent fields with an unknown number of mines adjacent to </span>
<span class="no"> 13</span> <span class="c"># it (or an actual mine).</span>
<span class="no"> 14</span> <span class="c"># &quot;&quot;&quot;</span>
<span class="no"> 15</span> <span class="c"># </span>
<span class="no"> 16</span> <span class="c"># E.g.</span>
<span class="no"> 17</span> <span class="c">#      &quot;..2.3.&quot;</span>
<span class="no"> 18</span> <span class="c">#      &quot;2.....&quot;</span>
<span class="no"> 19</span> <span class="c">#      &quot;..24.3&quot;</span>
<span class="no"> <strong>20</strong></span> <span class="c">#      &quot;1.34..&quot;</span>
<span class="no"> 21</span> <span class="c">#      &quot;.....3&quot;</span>
<span class="no"> 22</span> <span class="c">#      &quot;.3.3..&quot;</span>
<span class="no"> 23</span> <span class="c"># &quot;&quot;&quot;</span>
<span class="no"> 24</span> <span class="c"># </span>
<span class="no"> 25</span> <span class="c"># Also see </span>
<span class="no"> 26</span> <span class="c">#  </span>
<span class="no"> 27</span> <span class="c"># http://www.janko.at/Raetsel/Minesweeper/index.htm</span>
<span class="no"> 28</span> <span class="c">#</span>
<span class="no"> 29</span> <span class="c"># http://en.wikipedia.org/wiki/Minesweeper_(computer_game)</span>
<span class="no"> <strong>30</strong></span> <span class="c">#</span>
<span class="no"> 31</span> <span class="c"># Ian Stewart on Minesweeper: http://www.claymath.org/Popular_Lectures/Minesweeper/</span>
<span class="no"> 32</span> <span class="c">#</span>
<span class="no"> 33</span> <span class="c"># Richard Kaye's Minesweeper Pages</span>
<span class="no"> 34</span> <span class="c"># http://web.mat.bham.ac.uk/R.W.Kaye/minesw/minesw.htm</span>
<span class="no"> 35</span> <span class="c"># Some Minesweeper Configurations</span>
<span class="no"> 36</span> <span class="c"># http://web.mat.bham.ac.uk/R.W.Kaye/minesw/minesw.pdf</span>
<span class="no"> 37</span> <span class="c">#</span>
<span class="no"> 38</span> <span class="c"># Compare with my other Minesweeper models:</span>
<span class="no"> 39</span> <span class="c">#</span>
<span class="no"> <strong>40</strong></span> <span class="c"># - MiniZinc: http://www.hakank.org/minizinc/minesweeper.mzn</span>
<span class="no"> 41</span> <span class="c">#</span>
<span class="no"> 42</span> <span class="c"># - Choco: http://www.hakank.org/choco/MineSweeper.java</span>
<span class="no"> 43</span> <span class="c">#</span>
<span class="no"> 44</span> <span class="c"># - JaCoP: http://www.hakank.org/JaCoP/MineSweeper.java</span>
<span class="no"> 45</span> <span class="c">#</span>
<span class="no"> 46</span> <span class="c">#</span>
<span class="no"> 47</span> <span class="c"># Model created by Hakan Kjellerstrand, hakank@bonetmail.com</span>
<span class="no"> 48</span> <span class="c"># See also my Gecode/R page: http://www.hakank.org/gecode_r</span>
<span class="no"> 49</span> <span class="c">#</span>
<span class="no"> <strong>50</strong></span> <span class="c"># Slight modifications made by Andreas Launila to keep the example in</span>
<span class="no"> 51</span> <span class="c"># line with the other example models.</span>
<span class="no"> 52</span> <span class="r">class</span> <span class="cl">Minesweeper</span>
<span class="no"> 53</span>   include <span class="co">Gecode</span>::<span class="co">Mixin</span>
<span class="no"> 54</span> 
<span class="no"> 55</span>   <span class="c"># The provided +game+ should be a matrix encoding the problem in the</span>
<span class="no"> 56</span>   <span class="c"># following way:</span>
<span class="no"> 57</span>   <span class="c">#   -1 for the unknowns, </span>
<span class="no"> 58</span>   <span class="c">#  &gt;= 0 for number of mines in the neighbourhood</span>
<span class="no"> 59</span>   <span class="r">def</span> <span class="fu">initialize</span>(game)
<span class="no"> <strong>60</strong></span>     <span class="c"># Boolean variables representing whether each square has a mine or</span>
<span class="no"> 61</span>     <span class="c"># not.</span>
<span class="no"> 62</span>     mines_is_an bool_var_matrix(game.row_size, game.column_size)
<span class="no"> 63</span> 
<span class="no"> 64</span>     <span class="c"># Place the constraints.</span>
<span class="no"> 65</span>     game.row_size.times <span class="r">do</span> |i|
<span class="no"> 66</span>       game.column_size.times <span class="r">do</span> |j|
<span class="no"> 67</span>         <span class="c"># The sum of all the number of mines in the neighbourhood of this cell</span>
<span class="no"> 68</span>         <span class="c"># must agree with the problem specification.</span>
<span class="no"> 69</span>         <span class="r">if</span> game[i,j] &gt;= <span class="i">0</span> <span class="r">then</span>
<span class="no"> <strong>70</strong></span>           neighbourhood = mines.minor([i-<span class="i">1</span>,<span class="i">0</span>].max..(i+<span class="i">1</span>), [j-<span class="i">1</span>,<span class="i">0</span>].max..(j+<span class="i">1</span>))
<span class="no"> 71</span>           neighbourhood.to_a.flatten.sum.must == game[i,j]
<span class="no"> 72</span>         <span class="r">end</span>
<span class="no"> 73</span> 
<span class="no"> 74</span>         <span class="c"># A square can not contain a mine if the number of neighbouring</span>
<span class="no"> 75</span>         <span class="c"># mines is known.</span>
<span class="no"> 76</span>         <span class="r">if</span> game[i,j] &gt;= <span class="i">0</span> <span class="r">then</span>
<span class="no"> 77</span>           mines[i,j].must_be.false
<span class="no"> 78</span>         <span class="r">end</span>
<span class="no"> 79</span>       <span class="r">end</span>
<span class="no"> <strong>80</strong></span>     <span class="r">end</span>
<span class="no"> 81</span> 
<span class="no"> 82</span>     branch_on mines, <span class="sy">:variable</span> =&gt; <span class="sy">:largest_degree</span>, <span class="sy">:value</span> =&gt; <span class="sy">:max</span>
<span class="no"> 83</span>   <span class="r">end</span>
<span class="no"> 84</span> <span class="r">end</span>
<span class="no"> 85</span> 
<span class="no"> 86</span> <span class="r">class</span> <span class="cl">Array</span>
<span class="no"> 87</span>   <span class="c"># A helper for summing the contents of an array.</span>
<span class="no"> 88</span>   <span class="r">def</span> <span class="fu">sum</span>
<span class="no"> 89</span>     inject{ |sum, x| sum + x }
<span class="no"> <strong>90</strong></span>   <span class="r">end</span>
<span class="no"> 91</span> <span class="r">end</span>
<span class="no"> 92</span> 
<span class="no"> 93</span> <span class="c"># Problem from Gecode/examples/minesweeper.cc  problem 2</span>
<span class="no"> 94</span> <span class="co">X</span> = <span class="i">-1</span> <span class="c"># unknowns</span>
<span class="no"> 95</span> game = <span class="co">Matrix</span>[
<span class="no"> 96</span>   [<span class="i">1</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>],
<span class="no"> 97</span>   [<span class="co">X</span>,<span class="i">3</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">4</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">1</span>],
<span class="no"> 98</span>   [<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">1</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">4</span>,<span class="co">X</span>],
<span class="no"> 99</span>   [<span class="i">3</span>,<span class="co">X</span>,<span class="i">1</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>],
<span class="no"><strong>100</strong></span>   [<span class="co">X</span>,<span class="i">2</span>,<span class="i">1</span>,<span class="co">X</span>,<span class="i">1</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="i">2</span>],
<span class="no">101</span>   [<span class="co">X</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="i">1</span>,<span class="co">X</span>],
<span class="no">102</span>   [<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>],
<span class="no">103</span>   [<span class="co">X</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>],
<span class="no">104</span>   [<span class="co">X</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="i">3</span>,<span class="i">3</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>],
<span class="no">105</span>   [<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="co">X</span>,<span class="i">2</span>,<span class="i">2</span>,<span class="co">X</span>]
<span class="no">106</span> ]
<span class="no">107</span> 
<span class="no">108</span> minesweeper = <span class="co">Minesweeper</span>.new(game)
<span class="no">109</span> <span class="c"># Find all of the solutions.</span>
<span class="no"><strong>110</strong></span> num_solutions = <span class="i">0</span>
<span class="no">111</span> minesweeper.each_solution <span class="r">do</span> |s| 
<span class="no">112</span>   num_solutions += <span class="i">1</span>
<span class="no">113</span>   puts <span class="s"><span class="dl">&quot;</span><span class="ch">\n</span><span class="k">Solution #</span><span class="il"><span class="idl">#{</span>num_solutions<span class="idl">}</span></span><span class="ch">\n</span><span class="dl">&quot;</span></span>;
<span class="no">114</span>   <span class="c"># Print the solution.</span>
<span class="no">115</span>   s.mines.values.enum_slice(s.mines.column_size).each <span class="r">do</span> |row|
<span class="no">116</span>     puts row.map{ |filled| filled ? <span class="s"><span class="dl">&quot;</span><span class="k">X </span><span class="dl">&quot;</span></span> : <span class="s"><span class="dl">&quot;</span><span class="k">. </span><span class="dl">&quot;</span></span> }.join
<span class="no">117</span>   <span class="r">end</span>
<span class="no">118</span> <span class="r">end</span>
<span class="no">119</span> 
<span class="no"><strong>120</strong></span> puts <span class="s"><span class="dl">&quot;</span><span class="ch">\n</span><span class="k">Number of solutions: </span><span class="il"><span class="idl">#{</span>num_solutions<span class="idl">}</span></span><span class="dl">&quot;</span></span>
<span class="no">121</span> 
</pre></div>
</div>
</p>


	<h2 id="output">Output</h2>


<pre>
Solution #1
. . . . X . . . . . 
X . . X . X . X X . 
X X . . . X . X . . 
. . . . . . . . X . 
X . . . . . X . X . 
. . X . X . . . . . 
. X . . . . X . . . 
X . . . X . . . X . 
. X . X . . X . X X 
. . X . . X . . . . 

Number of solutions: 1
</pre>
  </div>
  <div id="tabs"><ul><li><a href="../features.html">Features</a></li><li><a href="../installation.html">Installation</a></li><li class="selected"><a href="index.html">Examples</a></li><li><a href="../documentation/index.html">Documentation</a></li><li><a href="../details/index.html">Project Details</a></li></ul></div>
</div>
<div id="footerWrapper">
  <div id="footer"><ul><li><a href="#top">Top</a></li><li><a href="../features.html">Features</a></li><li><a href="../installation.html">Installation</a></li><li class="selected"><a href="index.html">Examples</a></li><li><a href="../documentation/index.html">Documentation</a></li><li><a href="../details/index.html">Project Details</a></li><li><a class="sitemap" href="../sitemap.html">Sitemap</a></li></ul></div>
</div>
<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ?
  "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost +
  "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
   var pageTracker = _gat._getTracker("UA-546645-2");
   pageTracker._initData();
   pageTracker._trackPageview();
</script>
</body>
</html>